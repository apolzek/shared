<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Itens</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(252, 70, 107, 0.4);
        }

        .items-list {
            margin-top: 30px;
        }

        .item-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .item-card:hover {
            transform: translateY(-2px);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .item-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.1rem;
            color: #6c757d;
        }

        .no-items {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 1.1rem;
        }

        .debug-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 12px;
            color: #1565c0;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .content {
                padding: 20px;
            }

            .item-header {
                flex-direction: column;
                gap: 15px;
            }

            .item-actions {
                justify-content: flex-start;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Gerenciador de Itens</h1>
            <p>Aplica√ß√£o com observabilidade Faro/Alloy</p>
        </div>

        <div class="content">
            <div id="debug-info" class="debug-info">
                Status do Faro: <span id="faro-status">Inicializando...</span><br>
                Requests enviados: <span id="request-count">0</span><br>
                √öltimo erro: <span id="last-error">Nenhum</span>
            </div>

            <div id="message-container"></div>

            <div class="form-section">
                <h3 style="margin-bottom: 20px; color: #495057;">Adicionar/Editar Item</h3>
                <form id="item-form">
                    <div class="form-group">
                        <label for="item-name">Nome do Item:</label>
                        <input type="text" id="item-name" name="name" required>
                    </div>

                    <div class="form-group">
                        <label for="item-description">Descri√ß√£o:</label>
                        <textarea id="item-description" name="description" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="item-price">Pre√ßo:</label>
                        <input type="number" id="item-price" name="price" step="0.01" min="0">
                    </div>

                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        Adicionar Item
                    </button>
                    <button type="button" class="btn btn-warning" id="cancel-btn" style="display: none;">
                        Cancelar Edi√ß√£o
                    </button>
                </form>
            </div>

            <div class="items-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #495057;">Lista de Itens</h3>
                    <button class="btn btn-success" onclick="loadItems()">üîÑ Atualizar</button>
                </div>
                <div id="items-container">
                    <div class="loading">Carregando itens...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Grafana Faro
        const FARO_COLLECTOR_URL = 'http://localhost:12347/collect';
        let faroInitialized = false;
        let faroInstance = null;
        let requestCount = 0;
        let spanCount = 0;
        let tracer = null;
        let trace = null;
        let context = null;

        // Elementos de debug
        const faroStatusEl = document.getElementById('faro-status');
        const tracingStatusEl = document.getElementById('tracing-status');
        const requestCountEl = document.getElementById('request-count');
        const spanCountEl = document.getElementById('span-count');
        const lastErrorEl = document.getElementById('last-error');
        const lastTraceIdEl = document.getElementById('last-trace-id');
        const lastSpanNameEl = document.getElementById('last-span-name');

        function updateDebugInfo(status, error = null) {
            if (faroStatusEl) faroStatusEl.textContent = status;
            if (requestCountEl) requestCountEl.textContent = requestCount;
            if (spanCountEl) spanCountEl.textContent = spanCount;
            if (error && lastErrorEl) {
                lastErrorEl.textContent = error;
            }
        }

        function updateTracingInfo(status, traceId = null, spanName = null) {
            if (tracingStatusEl) tracingStatusEl.textContent = status;
            if (traceId && lastTraceIdEl) lastTraceIdEl.textContent = traceId;
            if (spanName && lastSpanNameEl) lastSpanNameEl.textContent = spanName;
        }

        // Fun√ß√£o para criar spans manuais
        function createSpan(spanName, operation, attributes = {}) {
            return new Promise((resolve, reject) => {
                if (!tracer) {
                    console.warn('Tracer n√£o dispon√≠vel, executando opera√ß√£o sem span');
                    resolve(operation());
                    return;
                }

                const span = tracer.startSpan(spanName, {
                    attributes: {
                        'component': 'item-manager',
                        'operation.type': spanName.split('.')[0],
                        ...attributes
                    }
                });

                spanCount++;
                updateTracingInfo('Ativo', span.spanContext().traceId, spanName);

                console.log(`üîç Span criado: ${spanName}`, {
                    traceId: span.spanContext().traceId,
                    spanId: span.spanContext().spanId,
                    attributes
                });

                context.with(trace.setSpan(context.active(), span), async () => {
                    try {
                        const startTime = Date.now();
                        const result = await operation();

                        span.setAttributes({
                            'operation.success': true,
                            'operation.duration_ms': Date.now() - startTime
                        });

                        // Corrigir o acesso ao SpanStatusCode
                        if (trace && trace.SpanStatusCode) {
                            span.setStatus({ code: trace.SpanStatusCode.OK });
                        } else {
                            // Fallback usando valores num√©ricos do OpenTelemetry
                            span.setStatus({ code: 1 }); // 1 = OK
                        }

                        resolve(result);
                    } catch (error) {
                        span.setAttributes({
                            'operation.success': false,
                            'error.message': error.message,
                            'error.type': error.constructor.name
                        });

                        // Corrigir o acesso ao SpanStatusCode para erro
                        if (trace && trace.SpanStatusCode) {
                            span.setStatus({
                                code: trace.SpanStatusCode.ERROR,
                                message: error.message
                            });
                        } else {
                            // Fallback usando valores num√©ricos do OpenTelemetry
                            span.setStatus({
                                code: 2, // 2 = ERROR
                                message: error.message
                            });
                        }

                        console.error(`‚ùå Erro no span ${spanName}:`, error);
                        reject(error);
                    } finally {
                        span.end();
                        console.log(`‚úÖ Span finalizado: ${spanName}`);
                    }
                });
            });
        }

        // Aguardar o carregamento dos SDKs
        let sdksLoaded = 0;
        const totalSDKs = 2;

        function checkSDKsLoaded() {
            sdksLoaded++;
            console.log(`SDK carregado ${sdksLoaded}/${totalSDKs}`);
            if (sdksLoaded >= totalSDKs) {
                setTimeout(initializeFaroWithTracing, 100); // Pequeno delay para garantir que tudo est√° pronto
            }
        }

        // Inicializar Faro com tracing corretamente
        function initializeFaroWithTracing() {
            if (faroInitialized || !window.GrafanaFaroWebSdk || !window.GrafanaFaroWebTracing) {
                console.log('SDKs n√£o carregados ainda:', {
                    webSdk: !!window.GrafanaFaroWebSdk,
                    tracing: !!window.GrafanaFaroWebTracing,
                    faroInitialized
                });
                return;
            }

            try {
                const { initializeFaro, getWebInstrumentations } = window.GrafanaFaroWebSdk;
                const { TracingInstrumentation } = window.GrafanaFaroWebTracing;

                console.log('üöÄ Inicializando Faro com tracing...');

                faroInstance = initializeFaro({
                    app: {
                        name: 'gerenciador-itens',
                        version: '1.0.0',
                        environment: 'development'
                    },
                    url: FARO_COLLECTOR_URL,
                    sessionTracking: {
                        enabled: true,
                        persistent: true
                    },
                    instrumentations: [
                        ...getWebInstrumentations({
                            captureConsole: true,
                            webVitals: true,
                            performance: true,
                            webVitalsThresholds: {
                                // Configurar thresholds para Web Vitals
                                CLS: { good: 0.1, poor: 0.25 },
                                FID: { good: 100, poor: 300 },
                                FCP: { good: 1800, poor: 3000 },
                                LCP: { good: 2500, poor: 4000 },
                                TTFB: { good: 800, poor: 1800 }
                            }
                        }),
                        new TracingInstrumentation({
                            enabled: true,
                            tracingOrigins: [/localhost/, /127\.0\.0\.1/],
                            propagateTraceHeaderCorsUrls: [/localhost/, /127\.0\.0\.1/]
                        })
                    ],
                    beforeSend: (payload) => {
                        console.log('üì§ Faro payload:', payload.type, payload);

                        // Se for uma medi√ß√£o (Web Vitals), adicionar labels necess√°rios
                        if (payload.type === 'measurement') {
                            // Adicionar os labels que a query espera
                            payload.meta = {
                                ...payload.meta,
                                kind: 'measurement',
                                Environment: 'local',
                                Application: 'gerenciador-itens'
                            };
                        }

                        requestCount++;
                        updateDebugInfo('Ativo - Enviando dados');
                        return payload;
                    }
                });

                // Configurar tracing manual
                if (faroInstance?.api?.getOTEL) {
                    const otel = faroInstance.api.getOTEL();
                    trace = otel.trace;
                    context = otel.context;
                    tracer = trace.getTracer('item-manager', '1.0.0');

                    // Verificar se SpanStatusCode est√° dispon√≠vel
                    console.log('üîç Verificando OTEL API:', {
                        trace: !!trace,
                        context: !!context,
                        tracer: !!tracer,
                        spanStatusCode: !!trace?.SpanStatusCode
                    });

                    updateTracingInfo('Ativo - Tracer configurado');
                    console.log('‚úÖ Tracer configurado com sucesso');
                } else {
                    updateTracingInfo('Erro - OTEL n√£o dispon√≠vel');
                    console.error('‚ùå OTEL API n√£o dispon√≠vel');
                }

                faroInitialized = true;
                updateDebugInfo('Ativo - Inicializado com tracing');
                captureWebVitals();
                // Criar span de inicializa√ß√£o
                if (tracer) {
                    createSpan('app.initialize', async () => {
                        console.log('Aplica√ß√£o inicializada com tracing');
                        return true;
                    }, {
                        'app.version': '1.0.0',
                        'page.url': window.location.href
                    });
                }

            } catch (error) {
                console.error('‚ùå Erro ao inicializar Grafana Faro:', error);
                updateDebugInfo('Erro na inicializa√ß√£o', error.message);
                updateTracingInfo('Erro na inicializa√ß√£o');
            }
        }

        function captureWebVitals() {
            // Fun√ß√£o para enviar m√©tricas no formato correto
            function sendWebVital(name, value, rating = 'good') {
                const vitalsData = {
                    type: 'measurement',
                    name: name.toLowerCase(),
                    value: value,
                    rating: rating,
                    timestamp: Date.now(),
                    kind: 'measurement',
                    Environment: 'local',
                    Application: 'gerenciador-itens'
                };

                console.log(`üìä Web Vital capturado: ${name} = ${value}ms (${rating})`);

                if (faroInstance?.api) {
                    try {
                        // Enviar como log estruturado no formato logfmt
                        faroInstance.api.pushLog([
                            `kind=measurement Environment=local Application=gerenciador-itens ` +
                            `metric=${name.toLowerCase()} value=${value} rating=${rating} ` +
                            `timestamp=${vitalsData.timestamp}`
                        ], {
                            level: 'info',
                            context: {
                                kind: 'measurement',
                                Environment: 'local',
                                Application: 'gerenciador-itens',
                                metric: name.toLowerCase(),
                                [name.toLowerCase()]: value // Para permitir unwrap na query
                            }
                        });

                        // Tamb√©m enviar como medi√ß√£o
                        faroInstance.api.pushMeasurement({
                            type: 'web_vital',
                            name: name.toLowerCase(),
                            value: value,
                            attributes: {
                                kind: 'measurement',
                                Environment: 'local',
                                Application: 'gerenciador-itens',
                                rating: rating,
                                metric_type: 'web_vital'
                            }
                        });
                    } catch (error) {
                        console.error('Erro ao enviar Web Vital:', error);
                    }
                }
            }

            // Capturar m√©tricas usando Performance Observer se dispon√≠vel
            if ('PerformanceObserver' in window) {
                try {
                    // Web Vitals: LCP (Largest Contentful Paint)
                    new PerformanceObserver((list) => {
                        for (const entry of list.getEntries()) {
                            if (entry.entryType === 'largest-contentful-paint') {
                                const rating = entry.startTime <= 2500 ? 'good' :
                                    entry.startTime <= 4000 ? 'needs-improvement' : 'poor';
                                sendWebVital('LCP', Math.round(entry.startTime), rating);
                            }
                        }
                    }).observe({ entryTypes: ['largest-contentful-paint'] });

                    // Web Vitals: FID (First Input Delay)
                    new PerformanceObserver((list) => {
                        for (const entry of list.getEntries()) {
                            if (entry.entryType === 'first-input') {
                                const fid = entry.processingStart - entry.startTime;
                                const rating = fid <= 100 ? 'good' :
                                    fid <= 300 ? 'needs-improvement' : 'poor';
                                sendWebVital('FID', Math.round(fid), rating);
                            }
                        }
                    }).observe({ entryTypes: ['first-input'] });

                    // Web Vitals: CLS (Cumulative Layout Shift)
                    let clsValue = 0;
                    new PerformanceObserver((list) => {
                        for (const entry of list.getEntries()) {
                            if (!entry.hadRecentInput) {
                                clsValue += entry.value;
                            }
                        }
                    }).observe({ entryTypes: ['layout-shift'] });

                    // Enviar CLS quando a p√°gina for "hidden"
                    document.addEventListener('visibilitychange', () => {
                        if (document.visibilityState === 'hidden') {
                            const rating = clsValue <= 0.1 ? 'good' :
                                clsValue <= 0.25 ? 'needs-improvement' : 'poor';
                            sendWebVital('CLS', Math.round(clsValue * 1000) / 1000, rating);
                        }
                    });

                } catch (error) {
                    console.error('Erro ao configurar PerformanceObserver:', error);
                }
            }

            // Fallback usando Navigation Timing API
            window.addEventListener('load', () => {
                setTimeout(() => {
                    if (window.performance && window.performance.timing) {
                        const timing = window.performance.timing;

                        // TTFB (Time to First Byte)
                        const ttfb = timing.responseStart - timing.requestStart;
                        const ttfbRating = ttfb <= 800 ? 'good' :
                            ttfb <= 1800 ? 'needs-improvement' : 'poor';
                        sendWebVital('TTFB', ttfb, ttfbRating);

                        // FCP aproximado (First Contentful Paint)
                        const fcp = timing.domContentLoadedEventEnd - timing.navigationStart;
                        const fcpRating = fcp <= 1800 ? 'good' :
                            fcp <= 3000 ? 'needs-improvement' : 'poor';
                        sendWebVital('FCP', fcp, fcpRating);

                        // Page Load Time total
                        const loadTime = timing.loadEventEnd - timing.navigationStart;
                        sendWebVital('PLT', loadTime, loadTime <= 3000 ? 'good' : 'poor');
                    }
                }, 0);
            });
        }

        // Helper para logs estruturados
        function logEvent(message, level = 'info', context = {}) {
            const timestamp = new Date().toISOString();
            const logData = {
                level,
                context: {
                    component: 'item-manager',
                    timestamp,
                    url: window.location.href,
                    userAgent: navigator.userAgent.substring(0, 100),
                    ...context
                }
            };

            console[level](`[${timestamp}] ${message}`, logData.context);

            if (faroInstance?.api) {
                try {
                    faroInstance.api.pushLog([message], {
                        level,
                        context: logData.context
                    });
                    updateDebugInfo('Ativo - Log enviado');
                } catch (error) {
                    updateDebugInfo('Erro no envio', error.message);
                }
            }
        }

        // Helper para m√©tricas customizadas
        function recordMetric(name, value, attributes = {}) {
            const metricData = {
                name,
                value,
                timestamp: Date.now(),
                attributes: {
                    component: 'item-manager',
                    environment: 'development',
                    ...attributes
                }
            };

            console.log(`üìä M√©trica: ${name} = ${value}`, metricData.attributes);

            if (faroInstance?.api) {
                try {
                    faroInstance.api.pushMeasurement({
                        type: 'counter',
                        name,
                        value,
                        attributes: metricData.attributes
                    });
                } catch (error) {
                    console.error('Erro ao enviar m√©trica:', error);
                }
            }
        }

        const API_BASE_URL = 'http://localhost:3002/api';
        let editingIndex = null;

        // Elementos do DOM
        const itemForm = document.getElementById('item-form');
        const itemsContainer = document.getElementById('items-container');
        const messageContainer = document.getElementById('message-container');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');

        // Inicializar a aplica√ß√£o
        document.addEventListener('DOMContentLoaded', function () {
            logEvent('Aplica√ß√£o iniciada', 'info', {
                pageUrl: window.location.href,
                referrer: document.referrer || 'direct'
            });
            loadItems();
            setupEventListeners();
        });

        // Configurar event listeners
        function setupEventListeners() {
            if (itemForm) {
                itemForm.addEventListener('submit', handleFormSubmit);
            }
            if (cancelBtn) {
                cancelBtn.addEventListener('click', cancelEdit);
            }
        }

        // Mostrar mensagens para o usu√°rio
        function showMessage(message, type = 'success') {
            if (!messageContainer) return;

            messageContainer.innerHTML = `
        <div class="message ${type}">
            ${message}
        </div>
    `;

            logEvent('Mensagem exibida ao usu√°rio', 'info', {
                message,
                messageType: type
            });

            setTimeout(() => {
                messageContainer.innerHTML = '';
            }, 5000);
        }

        // Carregar todos os itens com span
        async function loadItems() {
            if (!tracer) {
                // Fallback sem tracing
                return loadItemsWithoutSpan();
            }

            return createSpan('items.load', async () => {
                if (itemsContainer) {
                    itemsContainer.innerHTML = '<div class="loading">Carregando itens...</div>';
                }
                logEvent('Iniciando carregamento de itens', 'info');

                const response = await fetch(`${API_BASE_URL}/items`);

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} ${response.statusText}`);
                }

                const items = await response.json();
                displayItems(items);

                logEvent('Itens carregados com sucesso', 'info', {
                    itemCount: items.length
                });

                recordMetric('items_loaded', items.length);
                return items;
            }, {
                'http.method': 'GET',
                'http.url': `${API_BASE_URL}/items`
            });
        }

        // Fallback para carregar itens sem tracing
        async function loadItemsWithoutSpan() {
            try {
                if (itemsContainer) {
                    itemsContainer.innerHTML = '<div class="loading">Carregando itens...</div>';
                }
                logEvent('Iniciando carregamento de itens (sem tracing)', 'info');

                const response = await fetch(`${API_BASE_URL}/items`);

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} ${response.statusText}`);
                }

                const items = await response.json();
                displayItems(items);

                logEvent('Itens carregados com sucesso', 'info', {
                    itemCount: items.length
                });

                recordMetric('items_loaded', items.length);
                return items;
            } catch (error) {
                const errorMessage = `Erro ao carregar itens: ${error.message}`;
                logEvent(errorMessage, 'error', {
                    errorType: 'fetch_error',
                    httpStatus: error.message.includes('HTTP') ? error.message : null
                });

                if (itemsContainer) {
                    itemsContainer.innerHTML = `
                <div class="message error">
                    Erro ao carregar itens. Verifique se o servidor est√° rodando na porta 3002.
                    <br><small>Erro: ${error.message}</small>
                </div>
            `;
                }

                recordMetric('items_load_error', 1, {
                    errorType: 'fetch_error',
                    errorMessage: error.message
                });
                throw error;
            }
        }

        // Exibir itens na tela
        function displayItems(items) {
            if (!itemsContainer) return;

            if (items.length === 0) {
                itemsContainer.innerHTML = `
            <div class="no-items">
                üì¶ Nenhum item encontrado. Adicione o primeiro item!
            </div>
        `;
                return;
            }

            const itemsHTML = items.map((item, index) => `
        <div class="item-card">
            <div class="item-header">
                <div>
                    <h4 class="item-title">${escapeHtml(item.name || 'Item sem nome')}</h4>
                    <p style="color: #6c757d; margin: 5px 0;">
                        ${escapeHtml(item.description || 'Sem descri√ß√£o')}
                    </p>
                    ${item.price ? `<p style="color: #28a745; font-weight: 600; font-size: 1.1rem;">R$ ${parseFloat(item.price).toFixed(2)}</p>` : ''}
                </div>
                <div class="item-actions">
                    <button class="btn btn-warning" onclick="editItem(${index})">
                        ‚úèÔ∏è Editar
                    </button>
                    <button class="btn btn-danger" onclick="deleteItem(${index})">
                        üóëÔ∏è Excluir
                    </button>
                </div>
            </div>
        </div>
    `).join('');

            itemsContainer.innerHTML = itemsHTML;
        }

        // Fun√ß√£o para escapar HTML e prevenir XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Manipular envio do formul√°rio com span
        async function handleFormSubmit(e) {
            e.preventDefault();

            const formData = new FormData(itemForm);
            const itemData = {
                name: formData.get('name').trim(),
                description: formData.get('description').trim(),
                price: formData.get('price') ? parseFloat(formData.get('price')) : null
            };

            if (!itemData.name) {
                showMessage('Nome do item √© obrigat√≥rio!', 'error');
                logEvent('Valida√ß√£o falhou - nome vazio', 'warn', { formData: itemData });
                return;
            }

            const operation = editingIndex !== null ? 'update' : 'create';

            if (!tracer) {
                // Fallback sem tracing
                return handleFormSubmitWithoutSpan(itemData, operation);
            }

            return createSpan(`items.${operation}`, async () => {
                try {
                    if (editingIndex !== null) {
                        await updateItem(editingIndex, itemData);
                    } else {
                        await addItem(itemData);
                    }

                    resetForm();
                    await loadItems();
                    return itemData;
                } catch (error) {
                    const errorMessage = `Erro na opera√ß√£o ${operation}: ${error.message}`;
                    logEvent(errorMessage, 'error', {
                        operation,
                        errorType: 'operation_error',
                        httpStatus: error.message.includes('HTTP') ? error.message : null
                    });

                    showMessage(`Erro na opera√ß√£o. Tente novamente. (${error.message})`, 'error');
                    recordMetric('item_operation_error', 1, {
                        operation,
                        errorType: 'operation_error'
                    });
                    throw error;
                }
            }, {
                'item.name': itemData.name,
                'item.operation': operation,
                'item.index': editingIndex
            });
        }

        // Fallback para envio sem tracing
        async function handleFormSubmitWithoutSpan(itemData, operation) {
            try {
                logEvent(`Iniciando opera√ß√£o: ${operation} (sem tracing)`, 'info', {
                    operation,
                    itemData: { ...itemData, price: itemData.price || 'null' }
                });

                if (editingIndex !== null) {
                    await updateItemWithoutSpan(editingIndex, itemData);
                } else {
                    await addItemWithoutSpan(itemData);
                }

                resetForm();
                await loadItems();
                return itemData;
            } catch (error) {
                const errorMessage = `Erro na opera√ß√£o ${operation}: ${error.message}`;
                logEvent(errorMessage, 'error', {
                    operation,
                    errorType: 'operation_error',
                    httpStatus: error.message.includes('HTTP') ? error.message : null
                });

                showMessage(`Erro na opera√ß√£o. Tente novamente. (${error.message})`, 'error');
                recordMetric('item_operation_error', 1, {
                    operation,
                    errorType: 'operation_error'
                });
                throw error;
            }
        }

        // Adicionar novo item com span
        async function addItem(itemData) {
            if (!tracer) {
                return addItemWithoutSpan(itemData);
            }

            return createSpan('items.add', async () => {
                const response = await fetch(`${API_BASE_URL}/items`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(itemData)
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} ${response.statusText}`);
                }

                showMessage('Item adicionado com sucesso!');
                logEvent('Item adicionado com sucesso', 'info', { itemName: itemData.name });
                return response.json();
            }, {
                'http.method': 'POST',
                'http.url': `${API_BASE_URL}/items`,
                'item.name': itemData.name
            });
        }

        // Fallback para adicionar item sem span
        async function addItemWithoutSpan(itemData) {
            const response = await fetch(`${API_BASE_URL}/items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(itemData)
            });

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status} ${response.statusText}`);
            }

            showMessage('Item adicionado com sucesso!');
            logEvent('Item adicionado com sucesso', 'info', { itemName: itemData.name });
            return response.json();
        }

        // Atualizar item existente com span
        async function updateItem(index, itemData) {
            if (!tracer) {
                return updateItemWithoutSpan(index, itemData);
            }

            return createSpan('items.update', async () => {
                const response = await fetch(`${API_BASE_URL}/items/${index}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(itemData)
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} ${response.statusText}`);
                }

                showMessage('Item atualizado com sucesso!');
                logEvent('Item atualizado com sucesso', 'info', {
                    itemIndex: index,
                    itemName: itemData.name
                });
                return response.json();
            }, {
                'http.method': 'PUT',
                'http.url': `${API_BASE_URL}/items/${index}`,
                'item.index': index,
                'item.name': itemData.name
            });
        }

        // Fallback para atualizar item sem span
        async function updateItemWithoutSpan(index, itemData) {
            const response = await fetch(`${API_BASE_URL}/items/${index}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(itemData)
            });

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status} ${response.statusText}`);
            }

            showMessage('Item atualizado com sucesso!');
            logEvent('Item atualizado com sucesso', 'info', {
                itemIndex: index,
                itemName: itemData.name
            });
            return response.json();
        }

        // Editar item com span
        function editItem(index) {
            if (!tracer) {
                return editItemWithoutSpan(index);
            }

            createSpan('items.edit_start', async () => {
                logEvent('Iniciando edi√ß√£o de item', 'info', { itemIndex: index });

                const response = await fetch(`${API_BASE_URL}/items`);
                const items = await response.json();

                const item = items[index];
                if (item) {
                    if (document.getElementById('item-name')) {
                        document.getElementById('item-name').value = item.name || '';
                    }
                    if (document.getElementById('item-description')) {
                        document.getElementById('item-description').value = item.description || '';
                    }
                    if (document.getElementById('item-price')) {
                        document.getElementById('item-price').value = item.price || '';
                    }

                    editingIndex = index;
                    if (submitBtn) {
                        submitBtn.textContent = 'Atualizar Item';
                    }
                    if (cancelBtn) {
                        cancelBtn.style.display = 'inline-block';
                    }

                    const formSection = document.querySelector('.form-section');
                    if (formSection) {
                        formSection.scrollIntoView({ behavior: 'smooth' });
                    }

                    recordMetric('item_edit_started', 1, { itemIndex: index });
                    logEvent('Formul√°rio preenchido para edi√ß√£o', 'info', {
                        itemIndex: index,
                        itemName: item.name
                    });
                }
                return item;
            }, {
                'item.index': index,
                'operation.type': 'edit_prepare'
            }).catch(error => {
                logEvent('Erro ao carregar item para edi√ß√£o', 'error', {
                    itemIndex: index,
                    errorMessage: error.message
                });
            });
        }

        // Fallback para editar item sem span
        function editItemWithoutSpan(index) {
            logEvent('Iniciando edi√ß√£o de item (sem tracing)', 'info', { itemIndex: index });

            fetch(`${API_BASE_URL}/items`)
                .then(response => response.json())
                .then(items => {
                    const item = items[index];
                    if (item) {
                        if (document.getElementById('item-name')) {
                            document.getElementById('item-name').value = item.name || '';
                        }
                        if (document.getElementById('item-description')) {
                            document.getElementById('item-description').value = item.description || '';
                        }
                        if (document.getElementById('item-price')) {
                            document.getElementById('item-price').value = item.price || '';
                        }

                        editingIndex = index;
                        if (submitBtn) {
                            submitBtn.textContent = 'Atualizar Item';
                        }
                        if (cancelBtn) {
                            cancelBtn.style.display = 'inline-block';
                        }

                        const formSection = document.querySelector('.form-section');
                        if (formSection) {
                            formSection.scrollIntoView({ behavior: 'smooth' });
                        }

                        recordMetric('item_edit_started', 1, { itemIndex: index });
                        logEvent('Formul√°rio preenchido para edi√ß√£o', 'info', {
                            itemIndex: index,
                            itemName: item.name
                        });
                    }
                })
                .catch(error => {
                    logEvent('Erro ao carregar item para edi√ß√£o', 'error', {
                        itemIndex: index,
                        errorMessage: error.message
                    });
                });
        }

        // Deletar item com span
        async function deleteItem(index) {
            if (!confirm('Tem certeza que deseja excluir este item?')) {
                logEvent('Exclus√£o cancelada pelo usu√°rio', 'info', { itemIndex: index });
                return;
            }

            if (!tracer) {
                return deleteItemWithoutSpan(index);
            }

            return createSpan('items.delete', async () => {
                logEvent('Iniciando exclus√£o de item', 'info', { itemIndex: index });

                const response = await fetch(`${API_BASE_URL}/items/${index}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} ${response.statusText}`);
                }

                showMessage('Item exclu√≠do com sucesso!');
                await loadItems();

                recordMetric('item_delete_success', 1, { itemIndex: index });
                logEvent('Item exclu√≠do com sucesso', 'info', { itemIndex: index });
                return true;
            }, {
                'http.method': 'DELETE',
                'http.url': `${API_BASE_URL}/items/${index}`,
                'item.index': index
            }).catch(error => {
                const errorMessage = `Erro ao excluir item: ${error.message}`;
                logEvent(errorMessage, 'error', {
                    itemIndex: index,
                    errorType: 'delete_error',
                    httpStatus: error.message.includes('HTTP') ? error.message : null
                });

                showMessage(`Erro ao excluir item. Tente novamente. (${error.message})`, 'error');
                recordMetric('item_delete_error', 1, {
                    itemIndex: index,
                    errorType: 'delete_error'
                });
            });
        }

        // Fallback para deletar item sem span
        async function deleteItemWithoutSpan(index) {
            try {
                logEvent('Iniciando exclus√£o de item (sem tracing)', 'info', { itemIndex: index });

                const response = await fetch(`${API_BASE_URL}/items/${index}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} ${response.statusText}`);
                }

                showMessage('Item exclu√≠do com sucesso!');
                await loadItems();

                recordMetric('item_delete_success', 1, { itemIndex: index });
                logEvent('Item exclu√≠do com sucesso', 'info', { itemIndex: index });
                return true;
            } catch (error) {
                const errorMessage = `Erro ao excluir item: ${error.message}`;
                logEvent(errorMessage, 'error', {
                    itemIndex: index,
                    errorType: 'delete_error',
                    httpStatus: error.message.includes('HTTP') ? error.message : null
                });

                showMessage(`Erro ao excluir item. Tente novamente. (${error.message})`, 'error');
                recordMetric('item_delete_error', 1, {
                    itemIndex: index,
                    errorType: 'delete_error'
                });
                throw error;
            }
        }

        // Cancelar edi√ß√£o
        function cancelEdit() {
            logEvent('Edi√ß√£o cancelada pelo usu√°rio', 'info');
            resetForm();
        }

        // Resetar formul√°rio
        function resetForm() {
            if (itemForm) {
                itemForm.reset();
            }
            editingIndex = null;
            if (submitBtn) {
                submitBtn.textContent = 'Adicionar Item';
            }
            if (cancelBtn) {
                cancelBtn.style.display = 'none';
            }
        }

        // Capturar erros n√£o tratados
        window.addEventListener('error', (event) => {
            logEvent('Erro JavaScript n√£o tratado', 'error', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack?.substring(0, 500)
            });
        });

        // Capturar promises rejeitadas
        window.addEventListener('unhandledrejection', (event) => {
            logEvent('Promise rejeitada n√£o tratada', 'error', {
                reason: event.reason?.toString?.()?.substring(0, 200) || 'Unknown',
                stack: event.reason?.stack?.substring(0, 500)
            });
        });

        // Monitor de performance da p√°gina
        window.addEventListener('load', () => {
            if (!tracer) {
                // Fallback sem tracing
                if (window.performance && window.performance.timing) {
                    const timing = window.performance.timing;
                    const loadTime = timing.loadEventEnd - timing.navigationStart;
                    const domReady = timing.domContentLoadedEventEnd - timing.navigationStart;

                    recordMetric('page_load_time_ms', loadTime, {
                        domReadyMs: domReady,
                        pageType: 'main'
                    });

                    logEvent('Performance da p√°gina medida (sem tracing)', 'info', {
                        loadTimeMs: loadTime,
                        domReadyMs: domReady
                    });
                }
                return;
            }

            createSpan('page.load_complete', async () => {
                if (window.performance && window.performance.timing) {
                    const timing = window.performance.timing;
                    const loadTime = timing.loadEventEnd - timing.navigationStart;
                    const domReady = timing.domContentLoadedEventEnd - timing.navigationStart;

                    recordMetric('page_load_time_ms', loadTime, {
                        domReadyMs: domReady,
                        pageType: 'main'
                    });

                    logEvent('Performance da p√°gina medida', 'info', {
                        loadTimeMs: loadTime,
                        domReadyMs: domReady
                    });

                    return { loadTime, domReady };
                }
                return null;
            }, {
                'page.type': 'main',
                'performance.measured': true
            });
        });

        // Teste de tracing manual - para garantir que est√° funcionando
        function testTracing() {
            if (!tracer) {
                console.warn('‚ö†Ô∏è Tracer n√£o dispon√≠vel para teste');
                showMessage('Tracer n√£o dispon√≠vel para teste. Verifique se o Faro foi inicializado.', 'error');
                return;
            }

            createSpan('test.manual_trace', async () => {
                console.log('üß™ Executando teste de tracing manual...');

                // Simular uma opera√ß√£o ass√≠ncrona
                await new Promise(resolve => setTimeout(resolve, 100));

                console.log('‚úÖ Teste de tracing conclu√≠do com sucesso!');
                return 'test_success';
            }, {
                'test.type': 'manual',
                'test.timestamp': new Date().toISOString()
            }).then(() => {
                showMessage('Teste de tracing executado! Verifique o console.', 'success');
            }).catch(error => {
                console.error('‚ùå Erro no teste de tracing:', error);
                showMessage('Erro no teste de tracing!', 'error');
            });
        }

        // Adicionar bot√£o de teste no console
        console.log('üîß Para testar o tracing manualmente, execute: testTracing()');
        window.testTracing = testTracing;

        // Verificar periodicamente se o tracing est√° funcionando
        setInterval(() => {
            if (faroInitialized && tracer && spanCount > 0) {
                updateTracingInfo(`Ativo - ${spanCount} spans criados`,
                    lastTraceIdEl ? lastTraceIdEl.textContent : '',
                    lastSpanNameEl ? lastSpanNameEl.textContent : '');
            }
        }, 5000);

        // Fun√ß√£o para debug do estado do Faro
        function debugFaroState() {
            console.log('üîç Estado atual do Faro:', {
                faroInitialized,
                faroInstance: !!faroInstance,
                tracer: !!tracer,
                trace: !!trace,
                context: !!context,
                spanCount,
                requestCount,
                sdksLoaded,
                webSdk: !!window.GrafanaFaroWebSdk,
                tracingSdk: !!window.GrafanaFaroWebTracing
            });

            if (faroInstance) {
                console.log('üìä Inst√¢ncia Faro:', faroInstance);
                if (faroInstance.api) {
                    console.log('üîå API Faro dispon√≠vel:', Object.keys(faroInstance.api));
                }
            }

            return {
                initialized: faroInitialized,
                tracingReady: !!tracer,
                spansCreated: spanCount
            };
        }

        // Fun√ß√£o para for√ßar cria√ß√£o de spans de teste
        function createTestSpans() {
            if (!tracer) {
                console.warn('‚ö†Ô∏è Tracer n√£o dispon√≠vel');
                return;
            }

            // Criar m√∫ltiplos spans de teste
            const testOperations = [
                { name: 'test.operation_1', duration: 50 },
                { name: 'test.operation_2', duration: 100 },
                { name: 'test.operation_3', duration: 25 }
            ];

            testOperations.forEach((op, index) => {
                setTimeout(() => {
                    createSpan(op.name, async () => {
                        await new Promise(resolve => setTimeout(resolve, op.duration));
                        console.log(`‚úÖ Span de teste ${index + 1} conclu√≠do`);
                        return `test_result_${index + 1}`;
                    }, {
                        'test.index': index,
                        'test.duration_expected': op.duration,
                        'test.batch': 'manual_test'
                    });
                }, index * 200);
            });

            console.log(`üß™ Criando ${testOperations.length} spans de teste...`);
        }

        // Fun√ß√£o para verificar conectividade com o collector
        async function testCollectorConnection() {
            try {
                console.log('üîó Testando conex√£o com o collector...');

                const response = await fetch(FARO_COLLECTOR_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        test: 'connection',
                        timestamp: new Date().toISOString()
                    })
                });

                console.log('üì° Resposta do collector:', {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries())
                });

                if (response.ok) {
                    showMessage('Conex√£o com collector OK!', 'success');
                } else {
                    showMessage(`Erro de conex√£o: ${response.status}`, 'error');
                }

                return response.ok;
            } catch (error) {
                console.error('‚ùå Erro ao testar collector:', error);
                showMessage(`Erro ao conectar com collector: ${error.message}`, 'error');
                return false;
            }
        }

        // Adicionar fun√ß√µes de debug ao window para acesso via console
        window.debugFaroState = debugFaroState;
        window.createTestSpans = createTestSpans;
        window.testCollectorConnection = testCollectorConnection;

        // Fun√ß√£o para relat√≥rio de diagn√≥stico completo
        function diagnosticReport() {
            console.log('üìã RELAT√ìRIO DE DIAGN√ìSTICO DO TRACING');
            console.log('=====================================');

            const state = debugFaroState();

            console.log('1. Status dos SDKs:');
            console.log(`   ‚úÖ Web SDK: ${!!window.GrafanaFaroWebSdk}`);
            console.log(`   ‚úÖ Tracing SDK: ${!!window.GrafanaFaroWebTracing}`);
            console.log(`   üìä SDKs carregados: ${sdksLoaded}/${totalSDKs}`);

            console.log('\n2. Status da inicializa√ß√£o:');
            console.log(`   üöÄ Faro inicializado: ${state.initialized}`);
            console.log(`   üîç Tracer dispon√≠vel: ${state.tracingReady}`);
            console.log(`   üìà Spans criados: ${state.spansCreated}`);
            console.log(`   üì§ Requests enviados: ${requestCount}`);

            console.log('\n3. Configura√ß√£o:');
            console.log(`   üîó Collector URL: ${FARO_COLLECTOR_URL}`);
            console.log(`   üè∑Ô∏è App name: gerenciador-itens`);

            console.log('\n4. Comandos dispon√≠veis:');
            console.log('   testTracing() - Executar teste de span');
            console.log('   createTestSpans() - Criar m√∫ltiplos spans de teste');
            console.log('   testCollectorConnection() - Testar conex√£o com collector');
            console.log('   debugFaroState() - Ver estado detalhado');

            if (!state.initialized) {
                console.log('\n‚ö†Ô∏è  PROBLEMAS DETECTADOS:');
                console.log('   - Faro n√£o foi inicializado corretamente');
                console.log('   - Verifique se os SDKs foram carregados');
                console.log('   - Verifique o console para erros de carregamento');
            }

            if (!state.tracingReady) {
                console.log('\n‚ö†Ô∏è  TRACING N√ÉO DISPON√çVEL:');
                console.log('   - Tracer n√£o foi configurado');
                console.log('   - OTEL API pode n√£o estar dispon√≠vel');
                console.log('   - Verifique se TracingInstrumentation foi carregada');
            }

            return state;
        }

        window.diagnosticReport = diagnosticReport;

        // Auto-executar diagn√≥stico ap√≥s 3 segundos
        setTimeout(() => {
            console.log('\nüîç Executando diagn√≥stico autom√°tico...');
            diagnosticReport();
        }, 3000);

        // Listener para quando os SDKs terminarem de carregar
        document.addEventListener('DOMContentLoaded', () => {
            // Aguardar um pouco para os scripts carregarem
            setTimeout(() => {
                if (sdksLoaded < totalSDKs) {
                    console.warn('‚ö†Ô∏è Nem todos os SDKs foram carregados ainda');
                    updateDebugInfo('Aguardando SDKs...', 'SDKs n√£o carregados completamente');
                }
            }, 2000);
        });

        // Handler para carregamento dos scripts Faro
        window.onFaroWebSdkLoad = function () {
            console.log('‚úÖ Faro Web SDK carregado');
            checkSDKsLoaded();
        };

        window.onFaroTracingLoad = function () {
            console.log('‚úÖ Faro Web Tracing carregado');
            checkSDKsLoaded();
        };

        // Fallback se os scripts n√£o carregarem
        setTimeout(() => {
            if (!faroInitialized) {
                console.warn('‚ö†Ô∏è Faro n√£o foi inicializado ap√≥s 5 segundos');
                updateDebugInfo('Timeout na inicializa√ß√£o', 'SDKs n√£o carregaram em 5s');
                updateTracingInfo('Erro - Timeout');

                // Tentar inicializar mesmo assim
                if (window.GrafanaFaroWebSdk && window.GrafanaFaroWebTracing) {
                    console.log('üîÑ Tentando inicializa√ß√£o for√ßada...');
                    initializeFaroWithTracing();
                }
            }
        }, 5000);

        console.log('üöÄ Sistema de tracing carregado. Execute diagnosticReport() para verificar o status.');
    </script>
    <!-- Carregar Grafana Faro SDK -->
    <script src="https://unpkg.com/@grafana/faro-web-sdk@^1.0.0/dist/bundle/faro-web-sdk.iife.js"
        onerror="console.error('Erro ao carregar Faro Web SDK'); document.getElementById('faro-status').textContent = 'Erro - SDK n√£o carregado';"></script>

    <script src="https://unpkg.com/@grafana/faro-web-tracing@^1.0.0/dist/bundle/faro-web-tracing.iife.js"
        onerror="console.error('Erro ao carregar Faro Web Tracing'); updateDebugInfo('Erro - Tracing SDK n√£o carregado', 'SDK n√£o encontrado');"
        crossorigin></script>

</body>

</html>